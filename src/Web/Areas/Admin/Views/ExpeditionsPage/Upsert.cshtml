@model TravelCleanArch.Web.Areas.Admin.Models.ExpeditionFormViewModel
@using TravelCleanArch.Application.Abstractions.Travel
@{
    var isEdit = Model.Id.HasValue;
    var types = ViewBag.ExpeditionTypes as IReadOnlyCollection<ExpeditionTypeDto> ?? [];
    ViewData["Title"] = isEdit ? "Edit Expedition" : "Create Expedition";
}

<style>
    #departureGearTabContent > .tab-pane,
    #reviewsFaqTabContent > .tab-pane {
        display: none;
    }

    #departureGearTabContent > .tab-pane.active,
    #reviewsFaqTabContent > .tab-pane.active {
        display: block;
    }
</style>

<div class="container-fluid">
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <h2 class="mb-0">@(isEdit ? "Edit" : "Create") Expedition</h2>
        <a class="btn btn-outline-secondary" asp-action="Index">Back to list</a>
    </div>

    <div class="card">
        <div class="card-body">
            <form id="expeditionForm" method="post" enctype="multipart/form-data" asp-action="@(isEdit ? "Edit" : "Create")" asp-route-id="@Model.Id" novalidate>
                @Html.AntiForgeryToken()
                @if (isEdit)
                {
                    <input type="hidden" asp-for="Id" />
                }

                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <ul class="nav nav-tabs mb-4" id="expeditionWizardTabs" role="tablist">
                    <li class="nav-item"><button class="nav-link active" type="button" data-step="0">1. Basic Info</button></li>
                    <li class="nav-item"><button class="nav-link" type="button" data-step="1" disabled>2. Overview</button></li>
                    <li class="nav-item"><button class="nav-link" type="button" data-step="2" disabled>3. Itineraries</button></li>
                    <li class="nav-item"><button class="nav-link" type="button" data-step="3" disabled>4. Includes/Excludes</button></li>
                    <li class="nav-item"><button class="nav-link" type="button" data-step="4" disabled>5. Departure & Gear</button></li>
                    <li class="nav-item"><button class="nav-link" type="button" data-step="5" disabled>6. Reviews & FAQ</button></li>
                </ul>

                <div class="wizard-step" data-step="0">
                    <h5>Basic Information</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Name" class="form-label"></label>
                            <input asp-for="Name" class="form-control step-0-required" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="Slug" class="form-label"></label>
                            <input asp-for="Slug" class="form-control" />
                            <span asp-validation-for="Slug" class="text-danger"></span>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label asp-for="ShortDescription" class="form-label">Sub-description</label>
                            <textarea asp-for="ShortDescription" class="form-control step-0-required" rows="2"></textarea>
                            <span asp-validation-for="ShortDescription" class="text-danger"></span>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label asp-for="HeroImageUrl" class="form-label">Primary Image URL</label>
                            <input asp-for="HeroImageUrl" class="form-control" placeholder="https://..." />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Image Upload (analysis preview only)</label>
                            <input type="file" id="heroImageUpload" class="form-control" accept="image/*" />
                            <small class="text-muted">Upload to preview and fill image-analysis notes. Persisted image source remains URL field above.</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Image Analysis</label>
                            <textarea id="imageAnalysis" class="form-control" rows="4" placeholder="Highlights, terrain, weather cues, safety notes..."></textarea>
                        </div>
                        <div class="col-md-12 mb-3">
                            <img id="heroImagePreview" class="img-fluid rounded border d-none" style="max-height: 320px; object-fit: cover;" alt="Hero image preview" />
                        </div>
                    </div>
                </div>

                <div class="wizard-step d-none" data-step="1">
                    <h5>Overview</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label asp-for="Destination" class="form-label"></label>
                            <input asp-for="Destination" class="form-control step-1-required" />
                            <span asp-validation-for="Destination" class="text-danger"></span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label asp-for="Region" class="form-label"></label>
                            <input asp-for="Region" class="form-control" />
                            <span asp-validation-for="Region" class="text-danger"></span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label asp-for="ExpeditionTypeId" class="form-label">Expedition Type</label>
                            <select asp-for="ExpeditionTypeId" class="form-select">
                                <option value="">-- none --</option>
                                @foreach (var t in types)
                                {
                                    <option value="@t.Id">@t.Title</option>
                                }
                            </select>
                            <span asp-validation-for="ExpeditionTypeId" class="text-danger"></span>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label asp-for="DurationDays" class="form-label"></label>
                            <input asp-for="DurationDays" class="form-control step-1-required" type="number" min="1" max="365" />
                            <span asp-validation-for="DurationDays" class="text-danger"></span>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label asp-for="MaxAltitudeMeters" class="form-label"></label>
                            <input asp-for="MaxAltitudeMeters" class="form-control" type="number" min="0" max="12000" />
                            <span asp-validation-for="MaxAltitudeMeters" class="text-danger"></span>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label asp-for="Difficulty" class="form-label"></label>
                            <input asp-for="Difficulty" class="form-control step-1-required" />
                            <span asp-validation-for="Difficulty" class="text-danger"></span>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label asp-for="Price" class="form-label"></label>
                            <input asp-for="Price" class="form-control" type="number" min="0" step="0.01" />
                            <span asp-validation-for="Price" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="Status" class="form-label"></label>
                            <input asp-for="Status" class="form-control" />
                            <span asp-validation-for="Status" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="Ordering" class="form-label"></label>
                            <input asp-for="Ordering" class="form-control" type="number" min="0" max="999" />
                            <span asp-validation-for="Ordering" class="text-danger"></span>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label asp-for="Overview" class="form-label">Description / Overview</label>
                            <textarea asp-for="Overview" class="form-control step-1-required" rows="5"></textarea>
                            <span asp-validation-for="Overview" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="wizard-step d-none" data-step="2">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Multiple Itineraries (images + day tables)</h5>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="addItineraryVariant">Add Itinerary Variant</button>
                    </div>
                    <div id="itineraryVariants"></div>
                    <textarea asp-for="ItineraryText" class="d-none"></textarea>
                    <textarea asp-for="MediaText" class="d-none"></textarea>
                </div>

                <div class="wizard-step d-none" data-step="3">
                    <h5>Cost Includes & Excludes</h5>
                    <ul class="nav nav-pills mb-3" id="includeExcludeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="inclusions-tab" data-bs-toggle="pill" data-bs-target="#inclusions-panel" type="button" role="tab" aria-controls="inclusions-panel" aria-selected="true">Inclusions</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="exclusions-tab" data-bs-toggle="pill" data-bs-target="#exclusions-panel" type="button" role="tab" aria-controls="exclusions-panel" aria-selected="false">Exclusions</button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="inclusions-panel" role="tabpanel" aria-labelledby="inclusions-tab">
                            <p class="text-muted small mb-2">Add each included service with a short title and brief description.</p>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Inclusions table</label>
                                <button type="button" class="btn btn-outline-success btn-sm" id="addInclusion">Add Row</button>
                            </div>
                            <table class="table table-bordered" id="inclusionTable">
                                <thead>
                                    <tr>
                                        <th style="width: 30%">Title</th>
                                        <th>Short Description</th>
                                        <th style="width: 90px"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <div class="tab-pane fade" id="exclusions-panel" role="tabpanel" aria-labelledby="exclusions-tab">
                            <p class="text-muted small mb-2">Add each excluded service with a short title and brief description.</p>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Exclusions table</label>
                                <button type="button" class="btn btn-outline-danger btn-sm" id="addExclusion">Add Row</button>
                            </div>
                            <table class="table table-bordered" id="exclusionTable">
                                <thead>
                                    <tr>
                                        <th style="width: 30%">Title</th>
                                        <th>Short Description</th>
                                        <th style="width: 90px"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <textarea asp-for="Inclusions" class="d-none"></textarea>
                    <textarea asp-for="Exclusions" class="d-none"></textarea>
                </div>

                <div class="wizard-step d-none" data-step="4">
                    <h5>Departure & Gear</h5>
                    <ul class="nav nav-tabs mb-3" id="departureGearTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="departure-tab" data-bs-toggle="tab" data-bs-target="#departure-pane" type="button" role="tab" aria-controls="departure-pane" aria-selected="true">Departure</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="gear-tab" data-bs-toggle="tab" data-bs-target="#gear-pane" type="button" role="tab" aria-controls="gear-pane" aria-selected="false">Gear List</button>
                        </li>
                    </ul>

                    <div class="tab-content border border-top-0 rounded-bottom p-3 mb-3" id="departureGearTabContent">
                        <div class="tab-pane fade show active" id="departure-pane" role="tabpanel" aria-labelledby="departure-tab">
                            <p class="text-muted small mb-2">Add each departure separately (image, days, dates, status, and group size).</p>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Departure Rows</label>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="addDepartureRow">Add Departure</button>
                            </div>
                            <table class="table table-sm table-bordered" id="departureTable">
                                <thead>
                                    <tr>
                                        <th style="width: 22%;">Image URL</th>
                                        <th style="width: 10%;">Days</th>
                                        <th style="width: 16%;">Start Date</th>
                                        <th style="width: 16%;">End Date</th>
                                        <th style="width: 16%;">Status</th>
                                        <th style="width: 12%;">Group Size</th>
                                        <th style="width: 8%;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.FixedDepartures.Any())
                                    {
                                        for (var i = 0; i < Model.FixedDepartures.Count; i++)
                                        {
                                            var departure = Model.FixedDepartures[i];
                                            <tr class="departure-row">
                                                <td><input class="form-control departure-image" placeholder="https://..." /></td>
                                                <td><input class="form-control departure-days" name="FixedDepartures[@i].ForDays" type="number" min="0" value="@departure.ForDays" /></td>
                                                <td><input class="form-control departure-start" name="FixedDepartures[@i].StartDate" type="date" value="@departure.StartDate.ToString("yyyy-MM-dd")" /></td>
                                                <td><input class="form-control departure-end" name="FixedDepartures[@i].EndDate" type="date" value="@departure.EndDate.ToString("yyyy-MM-dd")" /></td>
                                                <td>
                                                    @* <select class="form-select departure-status" name="FixedDepartures[@i].Status"> *@
                                                       @*  <option value="BookingOpen" @(departure.Status == "BookingOpen" ? "selected" : null)>BookingOpen</option>
                                                        <option value="Limited" @(departure.Status == "Limited" ? "selected" : null)>Limited</option>
                                                        <option value="SoldOut" @(departure.Status == "SoldOut" ? "selected" : null)>SoldOut</option>
                                                        <option value="Closed" @(departure.Status == "Closed" ? "selected" : null)>Closed</option> *@
                                                        <select asp-for="FixedDepartures[@i].Status" class="form-select">
                                                            <option value="BookingOpen">BookingOpen</option>
                                                            <option value="Limited">Limited</option>
                                                            <option value="SoldOut">SoldOut</option>
                                                            <option value="Closed">Closed</option>
                                                        </select>

                                                    @* </select> *@
                                                </td>
                                                <td><input class="form-control departure-group" name="FixedDepartures[@i].GroupSize" type="number" min="1" value="@departure.GroupSize" /></td>
                                                <td class="text-end"><button type="button" class="btn btn-sm btn-link text-danger remove-departure-row">Remove</button></td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                            <textarea asp-for="AvailableDates" class="d-none"></textarea>
                        </div>
                        <div class="tab-pane fade" id="gear-pane" role="tabpanel" aria-labelledby="gear-tab">
                            <p class="text-muted small mb-2">Add gear documents with a short title and upload PDF/DOC/DOCX files.</p>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Gear Documents</label>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="addGearRow">Add Gear</button>
                            </div>
                            <table class="table table-sm table-bordered" id="gearTable">
                                <thead>
                                    <tr>
                                        <th style="width: 35%;">Title</th>
                                        <th>File Upload (PDF / DOC / DOCX)</th>
                                        <th style="width: 90px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.GearLists.Any())
                                    {
                                        for (var i = 0; i < Model.GearLists.Count; i++)
                                        {
                                            var gear = Model.GearLists[i];
                                            <tr class="gear-row">
                                                <td>
                                                    <input class="form-control gear-title" name="GearLists[@i].ShortDescription" value="@gear.ShortDescription" placeholder="Gear document title" />
                                                    <input type="hidden" class="gear-existing-path" name="GearLists[@i].ExistingPath" value="@gear.ExistingPath" />
                                                </td>
                                                <td>
                                                    <input type="file" class="form-control gear-file" name="GearLists[@i].UploadFile" accept=".pdf,.doc,.docx" />
                                                    @if (!string.IsNullOrWhiteSpace(gear.ExistingPath))
                                                    {
                                                        <small class="text-muted d-block mt-1">Current file: <a href="~/@gear.ExistingPath" target="_blank">@gear.ExistingPath</a></small>
                                                    }
                                                </td>
                                                <td class="text-end"><button type="button" class="btn btn-sm btn-link text-danger remove-gear-row">Remove</button></td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="wizard-step d-none" data-step="5">
                    <h5>Reviews & FAQ (multi-value inputs)</h5>
                    <ul class="nav nav-tabs mb-3" id="reviewsFaqTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews-pane" type="button" role="tab" aria-controls="reviews-pane" aria-selected="true">Reviews</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="faq-tab" data-bs-toggle="tab" data-bs-target="#faq-pane" type="button" role="tab" aria-controls="faq-pane" aria-selected="false">FAQs</button>
                        </li>
                    </ul>

                    <div class="tab-content border border-top-0 rounded-bottom p-3 mb-3" id="reviewsFaqTabContent">
                        <div class="tab-pane fade show active" id="reviews-pane" role="tabpanel" aria-labelledby="reviews-tab">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">Reviews</label>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="addReview">Add Review</button>
                            </div>
                            <table class="table table-sm table-bordered" id="reviewTable">
                                <thead><tr><th>Reviewer</th><th>Comment</th><th></th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <div class="tab-pane fade" id="faq-pane" role="tabpanel" aria-labelledby="faq-tab">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">FAQs</label>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="addFaq">Add FAQ</button>
                            </div>
                            <table class="table table-sm table-bordered" id="faqTable">
                                <thead><tr><th>Question</th><th>Answer</th><th></th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <textarea asp-for="FaqsText" class="d-none"></textarea>

                    <div class="mb-3">
                        <label asp-for="SectionsText" class="form-label">Additional Sections (optional raw format)</label>
                        <textarea asp-for="SectionsText" class="form-control" rows="3" placeholder="sectionType|title|content|ordering"></textarea>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-light" id="prevStep" disabled>Previous</button>
                    <div>
                        <button type="button" class="btn btn-primary" id="nextStep">Next</button>
                        <button type="submit" class="btn btn-success d-none" id="submitBtn">@(isEdit ? "Update" : "Create")</button>
                        <a asp-action="Index" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const tabs = Array.from(document.querySelectorAll("#expeditionWizardTabs .nav-link"));
            const steps = Array.from(document.querySelectorAll(".wizard-step"));
            const prevBtn = document.getElementById("prevStep");
            const nextBtn = document.getElementById("nextStep");
            const submitBtn = document.getElementById("submitBtn");
            let currentStep = 0;

            const sanitize = (text) => (text || "").replace(/\|/g, "/").replace(/\n/g, " ").trim();

            function renderStep() {
                steps.forEach((step, index) => step.classList.toggle("d-none", index !== currentStep));
                tabs.forEach((tab, index) => tab.classList.toggle("active", index === currentStep));
                prevBtn.disabled = currentStep === 0;
                nextBtn.classList.toggle("d-none", currentStep === steps.length - 1);
                submitBtn.classList.toggle("d-none", currentStep !== steps.length - 1);
            }

            function validateStep(stepIndex) {
                const requiredFields = document.querySelectorAll(`.step-${stepIndex}-required`);
                for (const field of requiredFields) {
                    if (!field.value.trim()) {
                        field.focus();
                        return false;
                    }
                }
                return true;
            }

            function goToStep(index) {
                if (index > currentStep && !validateStep(currentStep)) {
                    return;
                }

                for (let i = 0; i <= index; i += 1) {
                    tabs[i].disabled = false;
                }

                currentStep = index;
                renderStep();
            }

            tabs.forEach((tab, index) => tab.addEventListener("click", () => !tab.disabled && goToStep(index)));
            prevBtn.addEventListener("click", () => goToStep(Math.max(0, currentStep - 1)));
            nextBtn.addEventListener("click", () => goToStep(Math.min(steps.length - 1, currentStep + 1)));

            const heroUpload = document.getElementById("heroImageUpload");
            const heroPreview = document.getElementById("heroImagePreview");
            const imageAnalysis = document.getElementById("imageAnalysis");
            heroUpload.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = () => {
                    heroPreview.src = reader.result;
                    heroPreview.classList.remove("d-none");
                    imageAnalysis.value = `Image: ${file.name}\nSuggested usage: Hero banner + itinerary context\nNotes: Add terrain, camp-life, and summit visibility insights.`;
                };
                reader.readAsDataURL(file);
            });

            function addSimpleRow(target, titlePlaceholder, descriptionPlaceholder) {
                const row = document.createElement("tr");
                row.innerHTML = `<td><input class="form-control item-title" placeholder="${titlePlaceholder}" /></td><td><input class="form-control item-description" placeholder="${descriptionPlaceholder}" /></td><td class="text-end"><button type="button" class="btn btn-sm btn-link text-danger remove-row">Remove</button></td>`;
                target.appendChild(row);
            }

            const inclusionTableBody = document.querySelector("#inclusionTable tbody");
            const exclusionTableBody = document.querySelector("#exclusionTable tbody");
            document.getElementById("addInclusion").addEventListener("click", () => addSimpleRow(inclusionTableBody, "Title", "Short description"));
            document.getElementById("addExclusion").addEventListener("click", () => addSimpleRow(exclusionTableBody, "Title", "Short description"));
            addSimpleRow(inclusionTableBody, "Title", "Short description");
            addSimpleRow(exclusionTableBody, "Title", "Short description");

            function createItineraryDayRow() {
                return `<tr>
                    <td><input class="form-control day-number" type="number" min="1" placeholder="Day" /></td>
                    <td><input class="form-control day-title" placeholder="Title" /></td>
                    <td><input class="form-control day-desc" placeholder="Description" /></td>
                    <td><input class="form-control day-night" placeholder="Overnight" /></td>
                    <td><button type="button" class="btn btn-sm btn-link text-danger remove-row">Remove</button></td>
                </tr>`;
            }

            function addItineraryVariant(seed = "") {
                const block = document.createElement("div");
                block.className = "border rounded p-3 mb-3 itinerary-variant";
                block.innerHTML = `
                    <div class="row mb-2">
                        <div class="col-md-4"><input class="form-control variant-name" placeholder="Itinerary label (e.g. Spring 2026)" value="${seed}" /></div>
                        <div class="col-md-6"><input class="form-control variant-image" placeholder="Itinerary image/map URL" /></div>
                        <div class="col-md-2 text-end"><button type="button" class="btn btn-sm btn-outline-danger remove-variant">Remove Variant</button></div>
                    </div>
                    <table class="table table-sm table-bordered itinerary-days">
                        <thead><tr><th>Day</th><th>Title</th><th>Description</th><th>Overnight</th><th></th></tr></thead>
                        <tbody>${createItineraryDayRow()}</tbody>
                    </table>
                    <button type="button" class="btn btn-sm btn-outline-primary add-day">Add Day</button>
                `;
                document.getElementById("itineraryVariants").appendChild(block);
            }

            document.getElementById("addItineraryVariant").addEventListener("click", () => addItineraryVariant(""));
            addItineraryVariant("Default Plan");

            function addReviewRow(reviewer = "", comment = "") {
                const row = document.createElement("tr");
                row.innerHTML = `<td><input class="form-control reviewer" value="${reviewer}" /></td><td><input class="form-control review-comment" value="${comment}" /></td><td><button type="button" class="btn btn-sm btn-link text-danger remove-row">Remove</button></td>`;
                document.querySelector("#reviewTable tbody").appendChild(row);
            }

            function addFaqRow(q = "", a = "") {
                const row = document.createElement("tr");
                row.innerHTML = `<td><input class="form-control faq-question" value="${q}" /></td><td><input class="form-control faq-answer" value="${a}" /></td><td><button type="button" class="btn btn-sm btn-link text-danger remove-row">Remove</button></td>`;
                document.querySelector("#faqTable tbody").appendChild(row);
            }

            document.getElementById("addReview").addEventListener("click", () => addReviewRow());
            document.getElementById("addFaq").addEventListener("click", () => addFaqRow());
            addReviewRow();
            addFaqRow();

            const departureTableBody = document.querySelector("#departureTable tbody");
            function createDepartureRow(data = {}) {
                const row = document.createElement("tr");
                row.className = "departure-row";
                row.innerHTML = `<td><input class="form-control departure-image" placeholder="https://..." value="${data.image || ""}" /></td>
                    <td><input class="form-control departure-days" type="number" min="0" value="${data.days || 0}" /></td>
                    <td><input class="form-control departure-start" type="date" value="${data.startDate || ""}" /></td>
                    <td><input class="form-control departure-end" type="date" value="${data.endDate || ""}" /></td>
                    <td>
                        <select class="form-select departure-status">
                            <option value="BookingOpen">BookingOpen</option>
                            <option value="Limited">Limited</option>
                            <option value="SoldOut">SoldOut</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </td>
                    <td><input class="form-control departure-group" type="number" min="1" value="${data.groupSize || ""}" /></td>
                    <td class="text-end"><button type="button" class="btn btn-sm btn-link text-danger remove-departure-row">Remove</button></td>`;
                row.querySelector(".departure-status").value = data.status || "BookingOpen";
                return row;
            }

            function normalizeDepartureIndexes() {
                Array.from(document.querySelectorAll("#departureTable tbody .departure-row")).forEach((row, idx) => {
                    row.querySelector(".departure-days").setAttribute("name", `FixedDepartures[${idx}].ForDays`);
                    row.querySelector(".departure-start").setAttribute("name", `FixedDepartures[${idx}].StartDate`);
                    row.querySelector(".departure-end").setAttribute("name", `FixedDepartures[${idx}].EndDate`);
                    row.querySelector(".departure-status").setAttribute("name", `FixedDepartures[${idx}].Status`);
                    row.querySelector(".departure-group").setAttribute("name", `FixedDepartures[${idx}].GroupSize`);
                });
            }

            document.getElementById("addDepartureRow").addEventListener("click", () => {
                departureTableBody.appendChild(createDepartureRow());
                normalizeDepartureIndexes();
            });

            if (!departureTableBody.querySelector(".departure-row")) {
                departureTableBody.appendChild(createDepartureRow());
            }
            normalizeDepartureIndexes();

            const gearTableBody = document.querySelector("#gearTable tbody");
            function createGearRow(title = "", existingPath = "") {
                const row = document.createElement("tr");
                row.className = "gear-row";
                row.innerHTML = `<td>
                        <input class="form-control gear-title" placeholder="Gear document title" />
                        <input type="hidden" class="gear-existing-path" value="${existingPath}" />
                    </td>
                    <td>
                        <input type="file" class="form-control gear-file" accept=".pdf,.doc,.docx" />
                    </td>
                    <td class="text-end"><button type="button" class="btn btn-sm btn-link text-danger remove-gear-row">Remove</button></td>`;
                row.querySelector(".gear-title").value = title;
                return row;
            }

            function normalizeGearIndexes() {
                Array.from(document.querySelectorAll("#gearTable tbody .gear-row")).forEach((row, idx) => {
                    row.querySelector(".gear-title").setAttribute("name", `GearLists[${idx}].ShortDescription`);
                    row.querySelector(".gear-existing-path").setAttribute("name", `GearLists[${idx}].ExistingPath`);
                    row.querySelector(".gear-file").setAttribute("name", `GearLists[${idx}].UploadFile`);
                });
            }

            document.getElementById("addGearRow").addEventListener("click", () => {
                gearTableBody.appendChild(createGearRow());
                normalizeGearIndexes();
            });

            if (!gearTableBody.querySelector(".gear-row")) {
                gearTableBody.appendChild(createGearRow());
            }
            normalizeGearIndexes();

            document.addEventListener("click", (e) => {
                if (e.target.classList.contains("remove-row")) {
                    e.target.closest("tr")?.remove();
                }

                if (e.target.classList.contains("add-day")) {
                    const tbody = e.target.closest(".itinerary-variant").querySelector(".itinerary-days tbody");
                    tbody.insertAdjacentHTML("beforeend", createItineraryDayRow());
                }

                if (e.target.classList.contains("remove-variant")) {
                    e.target.closest(".itinerary-variant")?.remove();
                }

                if (e.target.classList.contains("remove-gear-row")) {
                    e.target.closest(".gear-row")?.remove();
                    if (!gearTableBody.querySelector(".gear-row")) {
                        gearTableBody.appendChild(createGearRow());
                    }
                    normalizeGearIndexes();
                }

                if (e.target.classList.contains("remove-departure-row")) {
                    e.target.closest(".departure-row")?.remove();
                    if (!departureTableBody.querySelector(".departure-row")) {
                        departureTableBody.appendChild(createDepartureRow());
                    }
                    normalizeDepartureIndexes();
                }
            });

            const form = document.getElementById("expeditionForm");
            form.addEventListener("submit", () => {
                const inclusionValues = Array.from(document.querySelectorAll("#inclusionTable tbody tr"))
                    .map((row) => {
                        const title = sanitize(row.querySelector(".item-title")?.value || "");
                        const description = sanitize(row.querySelector(".item-description")?.value || "");
                        return title && description ? `${title}|${description}` : title || description;
                    })
                    .filter(Boolean);
                document.getElementById("Inclusions").value = inclusionValues.join("\n");

                const exclusionValues = Array.from(document.querySelectorAll("#exclusionTable tbody tr"))
                    .map((row) => {
                        const title = sanitize(row.querySelector(".item-title")?.value || "");
                        const description = sanitize(row.querySelector(".item-description")?.value || "");
                        return title && description ? `${title}|${description}` : title || description;
                    })
                    .filter(Boolean);
                document.getElementById("Exclusions").value = exclusionValues.join("\n");

                let itineraryRows = [];
                let mediaRows = [];
                document.querySelectorAll(".itinerary-variant").forEach((variant, vIndex) => {
                    const label = sanitize(variant.querySelector(".variant-name").value || `Itinerary ${vIndex + 1}`);
                    const imageUrl = sanitize(variant.querySelector(".variant-image").value);
                    if (imageUrl) {
                        mediaRows.push(`${imageUrl}|${label} map|itinerary-map|${vIndex + 1}`);
                    }

                    variant.querySelectorAll(".itinerary-days tbody tr").forEach((row) => {
                        const day = sanitize(row.querySelector(".day-number")?.value || "");
                        const title = sanitize(row.querySelector(".day-title")?.value || "");
                        const desc = sanitize(row.querySelector(".day-desc")?.value || "");
                        const night = sanitize(row.querySelector(".day-night")?.value || "");
                        if (day && title) {
                            itineraryRows.push(`${day}|[${label}] ${title}|${desc}|${night}`);
                        }
                    });
                });

                document.getElementById("ItineraryText").value = itineraryRows.join("\n");
                document.getElementById("MediaText").value = mediaRows.join("\n");

                normalizeDepartureIndexes();
                const availableDateRows = [];
                document.querySelectorAll("#departureTable tbody tr").forEach((row) => {
                    const image = sanitize(row.querySelector(".departure-image")?.value || "");
                    const days = sanitize(row.querySelector(".departure-days")?.value || "");
                    const start = sanitize(row.querySelector(".departure-start")?.value || "");
                    const end = sanitize(row.querySelector(".departure-end")?.value || "");
                    const status = sanitize(row.querySelector(".departure-status")?.value || "BookingOpen");
                    const group = sanitize(row.querySelector(".departure-group")?.value || "");
                    if (start && end) {
                        availableDateRows.push(`${days}|${start}|${end}|${status}|${group}|${image}`);
                    }
                });
                document.getElementById("AvailableDates").value = availableDateRows.join("\n");

                const faqRows = [];
                document.querySelectorAll("#faqTable tbody tr").forEach((row, index) => {
                    const q = sanitize(row.querySelector(".faq-question")?.value || "");
                    const a = sanitize(row.querySelector(".faq-answer")?.value || "");
                    if (q && a) {
                        faqRows.push(`${q}|${a}|${index + 1}`);
                    }
                });
                document.getElementById("FaqsText").value = faqRows.join("\n");

                const sections = document.getElementById("SectionsText").value
                    .split("\n")
                    .map(x => x.trim())
                    .filter(Boolean);

                normalizeGearIndexes();

                const reviews = [];
                document.querySelectorAll("#reviewTable tbody tr").forEach((row, index) => {
                    const reviewer = sanitize(row.querySelector(".reviewer")?.value || "");
                    const comment = sanitize(row.querySelector(".review-comment")?.value || "");
                    if (reviewer && comment) {
                        reviews.push(`Review|${reviewer}|${comment}|${200 + index}`);
                    }
                });

                document.getElementById("SectionsText").value = [...sections, ...reviews].join("\n");
            });

            renderStep();
        })();
    </script>
}

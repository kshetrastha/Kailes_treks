@model TravelCleanArch.Web.Areas.Admin.Models.ExpeditionFormViewModel
@using TravelCleanArch.Application.Abstractions.Travel
@{
    var isEdit = Model.Id.HasValue;
    var types = ViewBag.ExpeditionTypes as IReadOnlyCollection<ExpeditionTypeDto> ?? [];
}

<h3>@(isEdit ? "Edit" : "Create") Expedition</h3>
<form method="post" enctype="multipart/form-data" asp-action="@(isEdit ? "Edit" : "Create")" asp-route-id="@Model.Id">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

    <ul class="nav nav-tabs expedition-tabs mb-2">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-basic">1. Basic + Overview</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-itin">2. Itineraries</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-cost">3. Cost + Departures</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-files">4. Gear + Maps + Media</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-reviews">5. Highlights + Reviews</a></li>
    </ul>

    <div class="tab-content border p-3 mb-3">
        <div class="tab-pane fade show active" id="tab-basic">
            <div class="row g-2">
                <div class="col-md-6"><label asp-for="Name"></label><input asp-for="Name" class="form-control" /></div>
                <div class="col-md-6"><label asp-for="ExpeditionTypeId"></label><select asp-for="ExpeditionTypeId" class="form-select"><option value="">--select--</option>@foreach (var t in types){<option value="@t.Id">@t.Title</option>}</select></div>
                <div class="col-md-6"><label asp-for="ShortDescription"></label><textarea asp-for="ShortDescription" class="form-control"></textarea></div>
                <div class="col-md-3"><label asp-for="OverviewCountry">Country</label><input asp-for="OverviewCountry" class="form-control" /></div>
                <div class="col-md-3"><label asp-for="PeakName"></label><input asp-for="PeakName" class="form-control" /></div>
                <div class="col-md-3"><label asp-for="DifficultyLevel"></label><select asp-for="DifficultyLevel" class="form-select"><option>Easy</option><option>Moderate</option><option>Difficult</option><option>HardDifficult</option><option>VeryHard</option></select></div>
                <div class="col-md-3"><label asp-for="MaxAltitudeMeters"></label><input asp-for="MaxAltitudeMeters" class="form-control" /></div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-itin">
            <table class="table" id="itineraryTable"><thead><tr><th>Season</th><th>Sort</th><th>Days (d#:short:meals:acc)</th></tr></thead><tbody>
                @for (var i=0;i<Model.Itineraries.Count;i++){
                    <tr><td><input type="hidden" name="Itineraries[@i].Id" value="@Model.Itineraries[i].Id" /><input name="Itineraries[@i].SeasonTitle" value="@Model.Itineraries[i].SeasonTitle" class="form-control"/></td><td><input name="Itineraries[@i].SortOrder" value="@Model.Itineraries[i].SortOrder" class="form-control"/></td><td><textarea class="form-control itin-days" data-index="@i">@string.Join("\n", Model.Itineraries[i].Days.Select(d=>$"{d.Id}:{d.DayNumber}:{d.ShortDescription}:{d.Meals}:{d.AccommodationType}"))</textarea></td></tr>
                }
            </tbody></table>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="addItinerary">Add itinerary</button>
        </div>

        <div class="tab-pane fade" id="tab-cost">
            <textarea asp-for="Inclusions" class="form-control mb-2" placeholder="Inclusions"></textarea>
            <textarea asp-for="Exclusions" class="form-control mb-2" placeholder="Exclusions"></textarea>
            <h6>Cost Items (title|type|sort)</h6><textarea id="costText" class="form-control" rows="4">@string.Join("\n", Model.CostItems.Select(c=>$"{c.Id}|{c.Title}|{c.Type}|{c.SortOrder}"))</textarea>
            <h6 class="mt-2">Fixed Departures (start|end|days|status|group)</h6><textarea id="departureText" class="form-control" rows="3">@string.Join("\n", Model.FixedDepartures.Select(d=>$"{d.Id}|{d.StartDate:yyyy-MM-dd}|{d.EndDate:yyyy-MM-dd}|{d.ForDays}|{d.Status}|{d.GroupSize}"))</textarea>
        </div>

        <div class="tab-pane fade" id="tab-files">
            <h6>Gear Files</h6>
            <div id="gearWrap">
                @for (var i = 0; i < Model.GearLists.Count; i++)
                {
                    <div class='row mb-1 gear-row'>
                        <input type='hidden' name='GearLists[@i].Id' value='@Model.GearLists[i].Id' />
                        <input type='hidden' name='GearLists[@i].ExistingPath' value='@Model.GearLists[i].ExistingPath' />
                        <input type='hidden' name='GearLists[@i].ExistingImagePath' value='@Model.GearLists[i].ExistingImagePath' />
                        <div class='col'><input name='GearLists[@i].ShortDescription' value='@Model.GearLists[i].ShortDescription' class='form-control' placeholder='description' /></div>
                        <div class='col'><input type='file' name='GearLists[@i].UploadFile' class='form-control' /></div>
                        <div class='col'><input type='file' name='GearLists[@i].UploadImage' class='form-control' /></div>
                    </div>
                }
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="addGear">Add Gear</button>
            <h6 class="mt-3">Maps</h6>
            <div id="mapWrap">
                @for (var i = 0; i < Model.Maps.Count; i++)
                {
                    <div class='row mb-1 map-row'>
                        <input type='hidden' name='Maps[@i].Id' value='@Model.Maps[i].Id' />
                        <input type='hidden' name='Maps[@i].ExistingPath' value='@Model.Maps[i].ExistingPath' />
                        <div class='col'><input name='Maps[@i].Title' value='@Model.Maps[i].Title' class='form-control' placeholder='title' /></div>
                        <div class='col'><input name='Maps[@i].Notes' value='@Model.Maps[i].Notes' class='form-control' placeholder='notes' /></div>
                        <div class='col'><input type='file' name='Maps[@i].UploadFile' class='form-control' /></div>
                    </div>
                }
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="addMap">Add Map</button>
            <h6 class="mt-3">Media</h6>
            <div id="mediaWrap">
                @for (var i = 0; i < Model.Media.Count; i++)
                {
                    <div class='row mb-1 media-row'>
                        <input type='hidden' name='Media[@i].Id' value='@Model.Media[i].Id' />
                        <input type='hidden' name='Media[@i].ExistingPath' value='@Model.Media[i].ExistingPath' />
                        <div class='col'><input type='file' name='Media[@i].PhotoFile' class='form-control' /></div>
                        <div class='col'><input name='Media[@i].VideoUrl' value='@Model.Media[i].VideoUrl' class='form-control' placeholder='video url' /></div>
                        <div class='col'><input name='Media[@i].Caption' value='@Model.Media[i].Caption' class='form-control' placeholder='caption' /></div>
                        <div class='col'><input name='Media[@i].SortOrder' value='@Model.Media[i].SortOrder' class='form-control' placeholder='sort' /></div>
                    </div>
                }
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="addMedia">Add Media</button>
        </div>

        <div class="tab-pane fade" id="tab-reviews">
            <h6>Highlights</h6><textarea id="highlightText" class="form-control" rows="3">@string.Join("\n", Model.Highlights.Select(h=>$"{h.Id}|{h.Text}|{h.SortOrder}"))</textarea>
            <h6 class="mt-2">Reviews (name|email|rating|status|text)</h6><textarea id="reviewText" class="form-control" rows="4">@string.Join("\n", Model.Reviews.Select(r=>$"{r.Id}|{r.FullName}|{r.EmailAddress}|{r.Rating}|{r.ModerationStatus}|{r.ReviewText}"))</textarea>
        </div>
    </div>

    <button class="btn btn-primary">Save</button> <a asp-action="Index" class="btn btn-light">Cancel</a>

    <textarea asp-for="SectionsText" class="d-none"></textarea><textarea asp-for="ItineraryText" class="d-none"></textarea><textarea asp-for="FaqsText" class="d-none"></textarea><textarea asp-for="MediaText" class="d-none"></textarea>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/expeditions-edit.js"></script>
}

@section Styles {
    <style>
        .expedition-tabs .nav-link {
            color: #1f2937;
            background-color: #f8fafc;
            border-color: #dee2e6;
        }

        .expedition-tabs .nav-link:hover,
        .expedition-tabs .nav-link:focus {
            color: #0d6efd;
            background-color: #ffffff;
        }

        .expedition-tabs .nav-link.active {
            color: #0d6efd;
            background-color: #ffffff;
            border-bottom-color: #ffffff;
            font-weight: 600;
        }
    </style>
}
